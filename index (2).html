<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged,
signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc,
collection, addDoc, getDocs, query, where }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const app = initializeApp({ /* YOUR FIREBASE CONFIG */ });
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser, isAdmin=false;

/* LOGIN */
window.login = async ()=>{
 try{
  await signInWithEmailAndPassword(auth,email.value,password.value);
 }catch{
  const cred = await createUserWithEmailAndPassword(auth,email.value,password.value);
  await setDoc(doc(db,"users",cred.user.uid),{role:"user"});
 }
};

window.logout=()=>signOut(auth);

/* AUTH STATE */
onAuthStateChanged(auth,async user=>{
 if(!user) return;
 currentUser=user;
 const snap = await getDoc(doc(db,"users",user.uid));
 isAdmin = snap.exists() && snap.data().role==="admin";
 adminPanel.style.display = isAdmin ? "block":"none";
 loadAnime();
});

/* ADMIN UPLOAD */
window.uploadEpisode = async ()=>{
 const file = videoFile.files[0];
 const storageRef = ref(storage,`videos/${file.name}`);
 await uploadBytes(storageRef,file);
 const url = await getDownloadURL(storageRef);

 await addDoc(collection(db,"episodes"),{
  anime:epAnime.value,
  title:epTitle.value,
  video:url
 });
 alert("Episode uploaded");
};

/* LOAD ANIME */
async function loadAnime(){
 const snap = await getDocs(collection(db,"anime"));
 animeList.innerHTML="";
 snap.forEach(d=>{
  animeList.innerHTML+=`<div onclick="loadEpisodes('${d.data().title}')">${d.data().title}</div>`;
 });
}

/* LOAD EPISODES + HISTORY */
window.loadEpisodes = async anime=>{
 episodeList.innerHTML="";
 const q=query(collection(db,"episodes"),where("anime","==",anime));
 const snap=await getDocs(q);
 snap.forEach(d=>{
  episodeList.innerHTML+=`
  <video controls src="${d.data().video}"
  ontimeupdate="saveProgress('${d.id}',this.currentTime)">
  </video>`;
 });
};

/* SAVE WATCH HISTORY */
window.saveProgress = async (ep,time)=>{
 await setDoc(doc(db,"history",currentUser.uid+"_"+ep),{
  user:currentUser.uid,
  episode:ep,
  time
 });
};
</script>

<!-- ADMIN PANEL -->
<div id="adminPanel" style="display:none">
<h2>Admin Upload</h2>
<input id="epAnime" placeholder="Anime">
<input id="epTitle" placeholder="Episode title">
<input type="file" id="videoFile">
<button onclick="uploadEpisode()">Upload Episode</button>
</div>
